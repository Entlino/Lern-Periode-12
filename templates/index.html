<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ title }}</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles.css') }}"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  </head>
  <body>
    <nav class="sidebar">
      <div class="brand">
        <i class="fa-solid fa-heart-pulse"></i> Garmin<span>DB</span>
      </div>
      <div class="nav-links">
        <a href="/" class="active"
          ><i class="fa-solid fa-chart-line"></i> Dashboard</a
        >
        <a
          href="#"
          onclick="document.getElementById('uploadModal').style.display='flex'"
          ><i class="fa-solid fa-upload"></i> Import</a
        >
        <a href="/download.csv?start={{start}}&end={{end}}"
          ><i class="fa-solid fa-file-csv"></i> Export</a
        >
        <a
          href="#"
          onclick="document.getElementById('settingsModal').style.display='flex'"
          ><i class="fa-solid fa-gear"></i> Settings</a
        >
      </div>

      <div class="filter-box">
        <small>Zeitraum</small>
        <form action="/" method="get">
          <input type="date" name="start" value="{{ start }}" />
          <input type="date" name="end" value="{{ end }}" />
          <button type="submit" class="btn-mini">
            <i class="fa-solid fa-filter"></i> Filtern
          </button>
        </form>
      </div>
    </nav>

    <main class="main-content">
      <header class="top-bar">
        <div>
          <h2>Hallo! üëã</h2>
          <p>Hier ist deine Gesundheits-√úbersicht.</p>
        </div>
        <div class="sync-status">
          <form action="/sync" method="post" style="display: inline">
            <input type="hidden" name="days" value="7" />
            <button type="submit" class="btn-sync">
              <i class="fa-solid fa-rotate"></i> Sync
            </button>
          </form>
        </div>
      </header>

      <div class="stats-grid">
        <div class="card kpi blue">
          <div class="icon"><i class="fa-solid fa-shoe-prints"></i></div>
          <div>
            <h3>{{ kpi.avg_steps | int }}</h3>
            <p>√ò Schritte</p>
          </div>
        </div>
        <div class="card kpi orange">
          <div class="icon"><i class="fa-solid fa-fire"></i></div>
          <div>
            <h3>{{ kpi.avg_cal | int }}</h3>
            <p>√ò Kalorien</p>
          </div>
        </div>
        <div class="card kpi red">
          <div class="icon"><i class="fa-solid fa-heart-crack"></i></div>
          <div>
            <h3>{{ kpi.avg_rhr | round(1) }}</h3>
            <p>√ò Ruhepuls</p>
          </div>
        </div>
        <div class="card kpi purple">
          <div class="icon"><i class="fa-solid fa-bed"></i></div>
          <div>
            <h3>{{ (kpi.avg_sleep / 60) | round(1) }} h</h3>
            <p>√ò Schlaf</p>
          </div>
        </div>
        <div class="card kpi blue {% if kpi.avg_steps >= step_goal %}goal-reached{% endif %}">
      </div>
    </div>

      <div class="card chart-container">
        <div class="chart-header">
          <h3><i class="fa-solid fa-chart-area"></i> Trend Analyse</h3>
          <div class="chart-controls">
            <button
              onclick="updateChart('steps')"
              class="chip active"
              id="btn-steps"
            >
              Schritte
            </button>
            <button onclick="updateChart('sleep')" class="chip" id="btn-sleep">
              Schlaf
            </button>
            <button
              onclick="updateChart('rest_hr')"
              class="chip"
              id="btn-rest_hr"
            >
              Puls
            </button>
          </div>
        </div>
        <div id="mainChart"></div>
      </div>

      <div class="card ai-container">
        <div class="ai-header">
          <div class="ai-avatar"><i class="fa-solid fa-robot"></i></div>
          <div>
            <h3>KI Coach</h3>
            <p>Frag mich nach Trends oder Zusammenh√§ngen</p>
          </div>
        </div>
        <div class="ai-body">
          <div id="aiResponse" class="ai-msg">
            Hallo! Ich analysiere deine Daten. Was m√∂chtest du wissen?
          </div>
        </div>
        <div class="ai-input">
          <input
            type="text"
            id="aiPrompt"
            placeholder="z.B. Warum schlafe ich schlecht?"
          />
          <button onclick="askAI()">
            <i class="fa-solid fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </main>

    <div id="uploadModal" class="modal">
      <div class="modal-content">
        <span
          onclick="document.getElementById('uploadModal').style.display='none'"
          class="close"
          >&times;</span
        >
        <h3>CSV Hochladen</h3>
        <form action="/upload" method="post" enctype="multipart/form-data">
          <input type="file" name="file" accept=".csv" />
          <button type="submit" class="btn-sync">Hochladen</button>
        </form>
      </div>
    </div>
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span onclick="document.getElementById('settingsModal').style.display='none'" class="close">&times;</span>
            <h3>Einstellungen</h3>
            <form action="/settings" method="post">

                <label style="display:block; margin-top:10px; font-weight:bold;">T√§gliches Schritt-Ziel</label>
                <input type="number" name="step_goal" value="{{ step_goal }}" style="width:100%; padding:8px; margin-top:5px; border:1px solid #ccc; border-radius:6px;">

                <label style="display:block; margin-top:20px; font-weight:bold;">KI Pers√∂nlichkeit</label>
                <select name="ai_persona" style="width:100%; padding:8px; margin-top:5px; border:1px solid #ccc; border-radius:6px;">
                    <option value="coach" {% if ai_persona == 'coach' %}selected{% endif %}>Standard Coach (Freundlich)</option>
                    <option value="drill" {% if ai_persona == 'drill' %}selected{% endif %}>Drill Sergeant (Hart)</option>
                    <option value="yogi" {% if ai_persona == 'yogi' %}selected{% endif %}>Yogi (Spirituell)</option>
                    <option value="nerd" {% if ai_persona == 'nerd' %}selected{% endif %}>Wissenschaftler (Pr√§zise)</option>
                </select>

                <button type="submit" class="btn-sync" style="margin-top:20px; width:100%;">Speichern</button>
            </form>
        </div>
    </div>
    <script>
      // Daten aus Python
      const chartData = {{ chart_data | tojson }};

      // Debugging: Schau in die Browser Konsole (F12), ob hier Daten ankommen
      console.log("Empfangene Daten:", chartData);

      const config = { responsive: true, displayModeBar: false };
      const layout = {
          margin: { t: 20, r: 20, l: 40, b: 40 },
          font: { family: 'Segoe UI, sans-serif' },
          showlegend: false,
          autosize: true,
          height: 350,
          xaxis: { gridcolor: '#f3f4f6' },
          yaxis: { gridcolor: '#f3f4f6' }
      };

      function updateChart(metric) {
          // Buttons stylen
          document.querySelectorAll('.chip').forEach(el => el.classList.remove('active'));
          document.getElementById('btn-' + metric).classList.add('active');

          let yValues, color, title;

          if (metric === 'steps') {
              yValues = chartData.steps; color = '#3b82f6'; title = 'Schritte';
          } else if (metric === 'sleep') {
              yValues = chartData.sleep; color = '#8b5cf6'; title = 'Schlaf (h)';
          } else if (metric === 'rest_hr') {
              yValues = chartData.rest_hr; color = '#ef4444'; title = 'Puls';
          }

          // Sicherstellen, dass Daten da sind
          if (!yValues || yValues.length === 0) {
              document.getElementById('mainChart').innerHTML = "<p style='text-align:center; padding:50px; color:#aaa;'>Keine Daten f√ºr diesen Filter.</p>";
              return;
          }

          const trace = {
              x: chartData.dates,
              y: yValues,
              type: 'scatter',
              mode: 'lines+markers',
              fill: 'tozeroy',
              line: { color: color, width: 3, shape: 'spline' },
              marker: { color: 'white', size: 6, line: {color: color, width: 2} }
          };

          Plotly.newPlot('mainChart', [trace], layout, config);
      }

      // Init
      updateChart('steps');

      async function askAI() {
          const promptInput = document.getElementById('aiPrompt');
          const output = document.getElementById('aiResponse');
          const btn = document.querySelector('.ai-input button');

          const txt = promptInput.value;
          if(!txt) return;

          output.innerHTML += `<br><strong>Du:</strong> ${txt}`;
          output.scrollTop = output.scrollHeight;
          promptInput.value = "";

          btn.innerHTML = "<i class='fa-solid fa-spinner fa-spin'></i>";

          try {
              const response = await fetch('/ai/coach', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ prompt: txt, metric: 'steps', start: "{{start}}", end: "{{end}}" })
              });
              const data = await response.json();
              output.innerHTML += `<br><br><strong>Coach:</strong> ${data.message || data.error}`;
          } catch (e) {
              output.innerHTML += `<br><em>Fehler: ${e}</em>`;
          }
          output.scrollTop = output.scrollHeight;
          btn.innerHTML = "<i class='fa-solid fa-paper-plane'></i>";
      }
    </script>
  </body>
</html>
